{% extends "base.html" %}

{% block content %}

<style>
/* ---------- SCOREBOARD STYLE SIMPLIFICADO ---------- */

.scoreboard-table {
    width: 95%;
    border-collapse: separate;
    border-spacing: 0 8px;
}

.scoreboard-row td {
    padding: 12px;
    vertical-align: middle;
    background-color: #e9ecef; /* fundo cinza claro */
    border-radius: 6px;
}

/* PRIMEIRA E √öLTIMA COLUNA */
.edge-left,
.edge-right {
    background-color: #ffffff !important;
}

/* manter arredondamento visual */
.edge-left {
    width: 200px;
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
}

.edge-right {
    width: 150px;
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
}

.court-cell {
    width: 150px;
    font-weight: bold;
    text-align: center;
    background: #f5f5f5;
    vertical-align: middle;
}

.team-players {
    line-height: 1.6;
    font-size: 0.95rem;
}

.team-left {
    text-align: right;
}

.team-right {
    text-align: left;
}

.score-cell {
    width: 60px;
    text-align: center;
}

.score-input {
    width: 42px;
    height: 38px;
    text-align: center;
    font-size: 1.1rem;
    font-weight: bold;
    background-color: #000;
    color: #fff;
    border: 1px solid #444;
    border-radius: 6px;
}

.score-input:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: none;
}

.vs-cell {
    width: 50px;
    font-weight: bold;
    font-size: 1.2rem;
    text-align: center;
    color: #212529;
}

.round-title {
    text-align: center;
    font-weight: bold;
    font-size: 1.3rem;
    margin-top: 30px;
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
}
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>
        {{ competition.name }} ‚Äî
        Jogos de {{ game_day.date.strftime('%d/%m/%Y') }} Grupo {{ game_day.group_name }}
    </h2>

    <div class="d-flex gap-2 align-items-center mb-3">
    {% if matches %}
        <form method="post"
              action="/game-days/{{ game_day.id }}/delete-matches"
              onsubmit="return confirm('Tem a certeza que deseja eliminar todos os jogos deste dia?');"
              class="d-flex">
            <button class="btn btn-sm btn-danger d-flex align-items-center">
                üóëÔ∏è Eliminar Jogos
            </button>
        </form>
        <!-- Bot√£o gerar PDF, se existir -->
    {% else %}
        <form method="post" action="/game-days/{{ game_day.id }}/generate-matches" class="d-flex">
            <button class="btn btn-sm btn-success d-flex align-items-center">
                üîÑ Gerar Jogos
            </button>
        </form>
    {% endif %}

    <a href="/game-days/competition/{{ game_day.competition_id }}" 
       class="btn btn-secondary btn-sm d-flex align-items-center">
        ‚Üê voltar para jornadas
    </a>
</div>

</div>

<!-- Mensagem de Erro/Warning -->
{% if error_msg %}
<div class="alert alert-warning" style="background-color: #fff3cd; color: #856404; border-color: #ffeeba;">
    ‚ö†Ô∏è {{ error_msg }}
</div>
{% endif %}
<!-- ---------- RESUMO DO GAME DAY + TOP 3 ---------- -->
<div class="alert alert-info">
    <strong>Resumo do Dia:</strong>
    Jogos: {{ summary.games }} |
    Rounds: {{ summary.rounds }} |
    Pontos Totais: {{ summary.points }} |
    M√©dia por Jogo: {{ summary.avg_points }}
</div>

{% if top3 or matches %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">

    {% if top3 %}
    <div>
        <strong>Top 3 do Dia:</strong>
        {% for player in top3 %}
            {% if loop.index == 1 %}
                ü•á {{ player.name }} ‚Äî {{ player.points }} pontos
            {% elif loop.index == 2 %}
                | ü•à {{ player.name }} ‚Äî {{ player.points }} pontos
            {% elif loop.index == 3 %}
                | ü•â {{ player.name }} ‚Äî {{ player.points }} pontos
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    {% if matches %}
    <div class="ms-auto mt-2 mt-md-0">
        <a href="/game-days/{{ game_day.id }}/ranking"
           class="btn btn-sm btn-info">
            üìä Ranking do Dia
        </a>
    </div>
    {% endif %}

</div>
{% endif %}

{% if matches %}
<form method="post" action="/matches/save-all/{{ game_day.id }}">
    <div class="mb-3">
        <button class="btn btn-primary">
            üíæ Guardar Resultados
        </button>
    </div>

    {% set rounds = matches | groupby('order') %}

    {% for round in rounds %}

        <table class="scoreboard-table">
            <thead>
                <td></td>
                <td></td>
                <td colspan="5">
                    <div class="round-title">
                    Round {{ round.grouper }}
                    </div>
                </td>
                <td></td>
                <td></td>
            </thead>
            <tbody>
                {% for match in round.list %}
                <tr class="scoreboard-row">
                    <td class="edge-left"></td>
                    <!-- Campo -->
                    <td class="court-cell">
                        Campo {{ match.court }}
                    </td>
                    
                    <!-- Team A -->
                    <td class="team-players team-left">
                        {% for pid in match.team_a_players.split(',') %}
                            üéæ {{ all_players_dict[pid].name }}<br>
                        {% endfor %}
                    </td>

                    <!-- Pontos A -->
                    <td class="score-cell">
                        <input type="number"
                               name="points_team_a_{{ match.id }}"
                               value="{{ match.points_team_a }}"
                               class="score-input"
                               min="0">
                    </td>

                    <!-- VS -->
                    <td class="vs-cell">
                        <strong>VS</strong>
                    </td>

                    <!-- Pontos B -->
                    <td class="score-cell">
                        <input type="number"
                               name="points_team_b_{{ match.id }}"
                               value="{{ match.points_team_b }}"
                               class="score-input"
                               min="0">
                    </td>

                    <!-- Team B -->
                    <td class="team-players team-right">
                        {% for pid in match.team_b_players.split(',') %}
                            üéæ {{ all_players_dict[pid].name }}<br>
                        {% endfor %}
                    </td>
                    <td class="edge-right"></td>
                    <td class="edge-right"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}

    <div class="mt-3">
        <button class="btn btn-primary">
            üíæ Guardar Resultados
        </button>
    </div>
</form>
{% else %}
    <p class="text-muted">Ainda n√£o existem jogos para este dia.</p>
{% endif %}

{% endblock %}
